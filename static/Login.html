<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Login - Sistema de Projetos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2em;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 2em;
            width: 100%;
            max-width: 400px;
        }

        .logo {
            text-align: center;
            margin-bottom: 2em;
        }

        .logo h1 {
            color: #333;
            font-weight: 700;
            margin-bottom: 0.5em;
        }

        .logo p {
            color: #666;
            margin-bottom: 0;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        .demo-accounts {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1em;
            margin-top: 1.5em;
            font-size: 0.9em;
        }

        .demo-accounts h6 {
            color: #495057;
            margin-bottom: 0.5em;
        }

        .demo-accounts ul {
            margin-bottom: 0;
            padding-left: 1em;
        }

        .demo-accounts li {
            margin-bottom: 0.25em;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="logo">
            <h1>游늵 Sistema de Projetos</h1>
            <p>Fa칞a login para continuar</p>
        </div>

        <!-- Formul치rio de Login -->
        <div class="mb-3">
            <label for="txtEmail" class="form-label">Email</label>
            <input type="email" id="txtEmail" class="form-control" placeholder="seu@email.com" />
        </div>

        <div class="mb-3">
            <label for="txtSenha" class="form-label">Senha</label>
            <input type="password" id="txtSenha" class="form-control" placeholder="Sua senha" />
        </div>

        <!-- Bot칚o de Login -->
        <div class="mb-3">
            <button id="btnLogin" class="btn btn-login w-100">Entrar</button>
        </div>

        <!-- Mensagens de resposta -->
        <div id="divResposta" class="alert" style="display: none;"></div>

        <!-- Contas de demonstra칞칚o -->
        <div class="demo-accounts">
            <h6>游늶 Contas para teste:</h6>
            <ul>
                <li><strong>Ana Silva:</strong> ana.silva@email.com / qualquer_senha</li>
                <li><strong>Bruno Costa:</strong> bruno.costa@email.com / qualquer_senha</li>
            </ul>
            <small class="text-muted">As senhas s칚o validadas com hash no servidor.</small>
        </div>

        <div class="text-center mt-3">
            <small class="text-muted">
                Sistema de Gerenciamento de Projetos v1.0
            </small>
        </div>
    </div>

    <script type="module">
        import ApiService from './ApiService.js';

        // Refer칡ncias para elementos do formul치rio
        const txtEmail = document.getElementById("txtEmail");
        const txtSenha = document.getElementById("txtSenha");
        const btnLogin = document.getElementById("btnLogin");
        const divResposta = document.getElementById("divResposta");

        // Verificar se j치 est치 logado
        const userData = localStorage.getItem("userData");
        if (userData) {
            window.location.href = "dashboard.html";
        }

        /**
         * Exibe mensagem na tela
         * @param {string} message - Mensagem a ser exibida
         * @param {string} type - Tipo da mensagem (success, danger, warning, info)
         */
        function showMessage(message, type) {
            divResposta.textContent = message;
            divResposta.className = `alert alert-${type}`;
            divResposta.style.display = 'block';
            
            // Auto-esconder mensagens de sucesso ap칩s 3 segundos
            if (type === 'success') {
                setTimeout(() => {
                    divResposta.style.display = 'none';
                }, 3000);
            }
        }

        /**
         * Valida os campos do formul치rio
         * @returns {boolean} True se v치lido, False se inv치lido
         */
        function validarFormulario() {
            if (txtEmail.value.trim() === "") {
                showMessage("Email 칠 obrigat칩rio", "warning");
                txtEmail.focus();
                return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(txtEmail.value)) {
                showMessage("Formato de email inv치lido", "warning");
                txtEmail.focus();
                return false;
            }

            if (txtSenha.value.trim() === "") {
                showMessage("Senha 칠 obrigat칩ria", "warning");
                txtSenha.focus();
                return false;
            }

            if (txtSenha.value.length < 1) {
                showMessage("Senha deve ter pelo menos 1 caractere", "warning");
                txtSenha.focus();
                return false;
            }

            return true;
        }

        /**
         * Realiza o login do usu치rio
         */
        async function realizarLogin() {
            // Validar formul치rio
            if (!validarFormulario()) {
                return;
            }

            // Mostrar loading no bot칚o
            btnLogin.disabled = true;
            btnLogin.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Entrando...';

            try {
                // Criar inst칙ncia da API (sem token inicial)
                const api = new ApiService();

                // Montar objeto de login
                const dadosLogin = {
                    "usuario": {
                        "email": txtEmail.value.trim(),
                        "senha_hash": txtSenha.value.trim()
                    }
                };

                console.log("Enviando requisi칞칚o de login...", dadosLogin);

                // Fazer requisi칞칚o para a API
                const resposta = await api.post("/api/usuarios/login", dadosLogin);
                console.log("Resposta da API:", resposta);

                if (resposta.success) {
                    showMessage("Login realizado com sucesso! Redirecionando...", "success");
                    
                    // Salvar dados do usu치rio no localStorage
                    localStorage.setItem("userData", JSON.stringify(resposta));
                    
                    // Redirecionar ap칩s breve delay
                    setTimeout(() => {
                        window.location.href = "dashboard.html";
                    }, 1000);
                    
                } else {
                    showMessage(resposta.error?.message || "Erro ao fazer login", "danger");
                }

            } catch (error) {
                console.error("Erro no login:", error);
                showMessage("Erro de conex칚o. Verifique se o servidor est치 rodando.", "danger");
            } finally {
                // Restaurar bot칚o
                btnLogin.disabled = false;
                btnLogin.textContent = "Entrar";
            }
        }

        // Event Listeners
        btnLogin.addEventListener("click", realizarLogin);

        // Permitir login com Enter
        txtSenha.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                realizarLogin();
            }
        });

        // Preencher com dados de demo para facilitar testes
        function preencherDemo(usuario) {
            if (usuario === 'ana') {
                txtEmail.value = "ana.silva@email.com";
                txtSenha.value = "hash_da_senha_da_ana";
            } else if (usuario === 'bruno') {
                txtEmail.value = "bruno.costa@email.com";
                txtSenha.value = "hash_da_senha_do_bruno";
            }
            showMessage(`Dados de ${usuario} preenchidos! Clique em Entrar.`, "info");
        }

        // Adicionar atalhos de teclado para preenchimento r치pido (apenas em desenvolvimento)
        document.addEventListener('keydown', function(event) {
            // Ctrl+1 para Ana, Ctrl+2 para Bruno (apenas em localhost)
            if (event.ctrlKey && window.location.hostname === 'localhost') {
                if (event.key === '1') {
                    event.preventDefault();
                    preencherDemo('ana');
                } else if (event.key === '2') {
                    event.preventDefault();
                    preencherDemo('bruno');
                }
            }
        });

        // Focar no campo de email ao carregar a p치gina
        txtEmail.focus();

        console.log("P치gina de login carregada. Use:");
        console.log("- ana.silva@email.com / qualquer_senha");
        console.log("- bruno.costa@email.com / qualquer_senha");
        console.log("- Em desenvolvimento: Ctrl+1 ou Ctrl+2 para preenchimento r치pido");
    </script>
</body>
</html>