<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Login - Sistema de Projetos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2em;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 2em;
            width: 100%;
            max-width: 400px;
        }

        .logo {
            text-align: center;
            margin-bottom: 2em;
        }

        .logo h1 {
            color: #333;
            font-weight: 700;
            margin-bottom: 0.5em;
        }

        .logo p {
            color: #666;
            margin-bottom: 0;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .alert {
            border-radius: 10px;
            border: none;
        }

        .demo-accounts {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1em;
            margin-top: 1.5em;
            font-size: 0.9em;
        }

        .demo-accounts h6 {
            color: #495057;
            margin-bottom: 0.5em;
        }

        .demo-accounts ul {
            margin-bottom: 0;
            padding-left: 1em;
        }

        .demo-accounts li {
            margin-bottom: 0.25em;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="logo">
            <h1>üìä Sistema de Projetos</h1>
            <p>Fa√ßa login para continuar</p>
        </div>

        <!-- Formul√°rio de Login -->
        <div class="mb-3">
            <label for="txtEmail" class="form-label">Email</label>
            <input type="email" id="txtEmail" class="form-control" placeholder="seu@email.com" />
        </div>

        <div class="mb-3">
            <label for="txtSenha" class="form-label">Senha</label>
            <input type="password" id="txtSenha" class="form-control" placeholder="Sua senha" />
        </div>

        <!-- Bot√£o de Login -->
        <div class="mb-3">
            <button id="btnLogin" class="btn btn-login w-100">Entrar</button>
        </div>

        <!-- Mensagens de resposta -->
        <div id="divResposta" class="alert" style="display: none;"></div>

        <!-- Contas de demonstra√ß√£o -->
        <div class="demo-accounts">
            <h6>üìã Contas para teste:</h6>
            <ul>
                <li><strong>Ana Silva:</strong> ana.silva@email.com / qualquer_senha</li>
                <li><strong>Bruno Costa:</strong> bruno.costa@email.com / qualquer_senha</li>
            </ul>
            <small class="text-muted">As senhas s√£o validadas com hash no servidor.</small>
        </div>

        <div class="text-center mt-3">
            <small class="text-muted">
                Sistema de Gerenciamento de Projetos v1.0
            </small>
        </div>
    </div>

    <script type="module">
        import ApiService from './ApiService.js';

        // Refer√™ncias para elementos do formul√°rio
        const txtEmail = document.getElementById("txtEmail");
        const txtSenha = document.getElementById("txtSenha");
        const btnLogin = document.getElementById("btnLogin");
        const divResposta = document.getElementById("divResposta");

        // Verificar se j√° est√° logado
        const userData = localStorage.getItem("userData");
        if (userData) {
            window.location.href = "dashboard.html";
        }

        /**
         * Exibe mensagem na tela
         * @param {string} message - Mensagem a ser exibida
         * @param {string} type - Tipo da mensagem (success, danger, warning, info)
         */
        function showMessage(message, type) {
            divResposta.textContent = message;
            divResposta.className = `alert alert-${type}`;
            divResposta.style.display = 'block';
            
            // Auto-esconder mensagens de sucesso ap√≥s 3 segundos
            if (type === 'success') {
                setTimeout(() => {
                    divResposta.style.display = 'none';
                }, 3000);
            }
        }

        /**
         * Valida os campos do formul√°rio
         * @returns {boolean} True se v√°lido, False se inv√°lido
         */
        function validarFormulario() {
            if (txtEmail.value.trim() === "") {
                showMessage("Email √© obrigat√≥rio", "warning");
                txtEmail.focus();
                return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(txtEmail.value)) {
                showMessage("Formato de email inv√°lido", "warning");
                txtEmail.focus();
                return false;
            }

            if (txtSenha.value.trim() === "") {
                showMessage("Senha √© obrigat√≥ria", "warning");
                txtSenha.focus();
                return false;
            }

            if (txtSenha.value.length < 1) {
                showMessage("Senha deve ter pelo menos 1 caractere", "warning");
                txtSenha.focus();
                return false;
            }

            return true;
        }

        /**
         * Realiza o login do usu√°rio
         */
        async function realizarLogin() {
            // Validar formul√°rio
            if (!validarFormulario()) {
                return;
            }

            // Mostrar loading no bot√£o
            btnLogin.disabled = true;
            btnLogin.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Entrando...';

            try {
                // Criar inst√¢ncia da API (sem token inicial)
                const api = new ApiService();

                // Montar objeto de login
                const dadosLogin = {
                    "usuario": {
                        "email": txtEmail.value.trim(),
                        "senha_hash": txtSenha.value.trim()
                    }
                };

                console.log("Enviando requisi√ß√£o de login...", dadosLogin);

                // ‚úÖ CORRE√á√ÉO: URL ABSOLUTA com localhost:5000
                const resposta = await api.post("http://localhost:5000/api/usuarios/login", dadosLogin);
                console.log("Resposta da API:", resposta);

                if (resposta.success) {
                    showMessage("Login realizado com sucesso! Redirecionando...", "success");
                    
                    // Salvar dados do usu√°rio no localStorage
                    localStorage.setItem("userData", JSON.stringify(resposta));
                    localStorage.setItem("token", resposta.data.token);
                    
                    // Redirecionar ap√≥s breve delay
                    setTimeout(() => {
                        window.location.href = "dashboard.html";
                    }, 1000);
                    
                } else {
                    showMessage(resposta.error?.message || "Erro ao fazer login", "danger");
                }

            } catch (error) {
                console.error("Erro no login:", error);
                showMessage("Erro de conex√£o. Verifique se o servidor est√° rodando.", "danger");
            } finally {
                // Restaurar bot√£o
                btnLogin.disabled = false;
                btnLogin.textContent = "Entrar";
            }
        }

        // Event Listeners
        btnLogin.addEventListener("click", realizarLogin);

        // Permitir login com Enter
        txtSenha.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                realizarLogin();
            }
        });

        // Preencher com dados de demo para facilitar testes
        function preencherDemo(usuario) {
            if (usuario === 'ana') {
                txtEmail.value = "ana.silva@email.com";
                txtSenha.value = "qualquer_senha"; // ‚úÖ CORRE√á√ÉO: senha real, n√£o o hash
            } else if (usuario === 'bruno') {
                txtEmail.value = "bruno.costa@email.com";
                txtSenha.value = "qualquer_senha"; // ‚úÖ CORRE√á√ÉO: senha real, n√£o o hash
            } else if (usuario === 'mateus') {
                txtEmail.value = "mateus@email.com";
                txtSenha.value = "123456";
            }
            showMessage(`Dados de ${usuario} preenchidos! Clique em Entrar.`, "info");
        }

        // Adicionar atalhos de teclado para preenchimento r√°pido (apenas em desenvolvimento)
        document.addEventListener('keydown', function(event) {
            // Ctrl+1 para Ana, Ctrl+2 para Bruno, Ctrl+3 para Mateus (apenas em localhost)
            if (event.ctrlKey && window.location.hostname === 'localhost') {
                if (event.key === '1') {
                    event.preventDefault();
                    preencherDemo('ana');
                } else if (event.key === '2') {
                    event.preventDefault();
                    preencherDemo('bruno');
                } else if (event.key === '3') {
                    event.preventDefault();
                    preencherDemo('mateus');
                }
            }
        });

        // Focar no campo de email ao carregar a p√°gina
        txtEmail.focus();

        console.log("P√°gina de login carregada. Use:");
        console.log("- mateus@email.com / 123456");
        console.log("- ana.silva@email.com / qualquer_senha");
        console.log("- bruno.costa@email.com / qualquer_senha");
        console.log("- Em desenvolvimento: Ctrl+1, Ctrl+2 ou Ctrl+3 para preenchimento r√°pido");
    </script>
</body>
</html>