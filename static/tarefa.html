<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Gerenciamento de Tarefas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/css/bootstrap.min.css" rel="stylesheet" />
  <script src="/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      padding: 2em;
    }

    table {
      margin-top: 1em;
    }

    .concluida-true { text-decoration: line-through; color: #6c757d; }
    .concluida-false { font-weight: bold; }
  </style>
</head>

<body class="container">
  <h1 class="mb-4" id="tituloPagina">Gerenciamento de Tarefas</h1>

  <!-- ======================== INFO DO PROJETO ======================== -->
  <div class="card mb-3" id="cardProjetoInfo" style="display: none;">
    <div class="card-header">Projeto Selecionado</div>
    <div class="card-body">
      <strong id="infoProjetoNome"></strong>
      <button id="btnVoltarProjetos" class="btn btn-outline-secondary btn-sm ms-3">Voltar para Projetos</button>
    </div>
  </div>

  <!-- ======================== FORMULÁRIO DE CADASTRO ======================== -->
  <div class="card mb-4">
    <div class="card-header">Cadastro de Tarefa</div>
    <div class="card-body">
      <div class="mb-3">
        <input type="number" id="txtId" class="form-control mb-2" disabled placeholder="ID" />
        <input type="text" id="txtTitulo" class="form-control mb-2" placeholder="Título da tarefa" />
        
        <div class="row mb-2">
          <div class="col">
            <label for="txtDataLimite" class="form-label">Data Limite</label>
            <input type="date" id="txtDataLimite" class="form-control">
          </div>
          <div class="col">
            <label for="cboProjeto" class="form-label">Projeto</label>
            <select id="cboProjeto" class="form-select">
              <option value="-1">Selecione um projeto</option>
            </select>
          </div>
        </div>

        <div class="form-check mb-3">
          <input type="checkbox" id="chkConcluida" class="form-check-input">
          <label class="form-check-label" for="chkConcluida">Tarefa concluída</label>
        </div>
      </div>

      <div class="mb-3 d-flex gap-2" id="divBotoes"></div>
    </div>

    <div id="divResposta" class="alert d-inline-block p-2"></div>
  </div>

  <!-- ======================== TABELA DE TAREFAS ======================== -->
  <div class="card mt-4">
    <div class="card-header">
      Lista de Tarefas
    </div>
    <div class="card-body">
      <div id="divTabela"></div>
    </div>
  </div>

  <!-- Modal de Confirmação -->
  <div class="modal fade" id="modalConfirm" tabindex="-1" aria-labelledby="modalConfirmLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalConfirmLabel">Confirmação</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          Tem certeza que deseja excluir esta tarefa?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="btnConfirmDelete">Excluir</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import ApiService from './ApiService.js';

    // ======================== AUTENTICAÇÃO ========================
    let userData = localStorage.getItem("userData");
    if (userData) userData = JSON.parse(userData);
    else window.location.href = "login.html";

    const token = userData.data.token;
    const api = new ApiService(token);

    let API_DATA;
    let projetosList = [];
    let projetoSelecionado = null;

    // ======================== ELEMENTOS HTML ========================
    const txtId = document.getElementById("txtId");
    const txtTitulo = document.getElementById("txtTitulo");
    const txtDataLimite = document.getElementById("txtDataLimite");
    const cboProjeto = document.getElementById("cboProjeto");
    const chkConcluida = document.getElementById("chkConcluida");
    const divBotoes = document.getElementById("divBotoes");
    const divResposta = document.getElementById("divResposta");
    const cardProjetoInfo = document.getElementById("cardProjetoInfo");
    const infoProjetoNome = document.getElementById("infoProjetoNome");
    const btnVoltarProjetos = document.getElementById("btnVoltarProjetos");
    const tituloPagina = document.getElementById("tituloPagina");

    // ======================== VERIFICAR PARÂMETROS URL ========================
    const urlParams = new URLSearchParams(window.location.search);
    const projetoIdUrl = urlParams.get('projeto_id');
    const projetoNomeUrl = urlParams.get('projeto_nome');

    if (projetoIdUrl && projetoNomeUrl) {
      projetoSelecionado = {
        id: projetoIdUrl,
        nome: decodeURIComponent(projetoNomeUrl)
      };
      cardProjetoInfo.style.display = 'block';
      infoProjetoNome.textContent = projetoNomeUrl;
      tituloPagina.textContent = `Tarefas do Projeto: ${projetoNomeUrl}`;
    }

    // ======================== FUNÇÃO AUXILIAR PARA CRIAR BOTÕES ========================
    function createButton(text, className) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.className = `btn ${className} flex-fill`;
      return btn;
    }

    // ======================== BOTÕES CRUD ========================
    const btnListar = createButton("Listar", "btn-primary");
    btnListar.onclick = listAll;
    divBotoes.appendChild(btnListar);

    const btnCriar = createButton("Criar", "btn-success");
    btnCriar.onclick = async () => {
      if (txtTitulo.value.trim() === "") {
        showMessage("Título da tarefa é obrigatório", "warning");
        return;
      }

      if (cboProjeto.value === "-1") {
        showMessage("Selecione um projeto", "warning");
        return;
      }

      const objetoCriar = {
        "tarefa": {
          "titulo": txtTitulo.value.trim(),
          "data_limite": txtDataLimite.value || null,
          "concluida": chkConcluida.checked,
          "projeto_id": parseInt(cboProjeto.value)
        }
      };

      const resposta = await api.post("/api/tarefas/", objetoCriar);
      if (resposta.success) {
        showMessage("Tarefa criada com sucesso!", "success");
        if (projetoSelecionado) {
          listPorProjeto();
        } else {
          listAll();
        }
        limparFormulario();
      } else {
        showMessage(resposta.error.message, "danger");
      }
    };
    divBotoes.appendChild(btnCriar);

    const btnAtualizar = createButton("Atualizar", "btn-warning");
    btnAtualizar.onclick = async () => {
      const id = txtId.value.trim();
      if (!id) {
        showMessage("Selecione uma tarefa para atualizar", "danger");
        return;
      }

      if (txtTitulo.value.trim() === "") {
        showMessage("Título da tarefa é obrigatório", "warning");
        return;
      }

      const objetoAtualizar = {
        "tarefa": {
          "titulo": txtTitulo.value.trim(),
          "data_limite": txtDataLimite.value || null,
          "concluida": chkConcluida.checked,
          "projeto_id": parseInt(cboProjeto.value)
        }
      };

      const resposta = await api.put("/api/tarefas/", id, objetoAtualizar);
      if (resposta.success) {
        showMessage("Tarefa atualizada com sucesso!", "success");
        if (projetoSelecionado) {
          listPorProjeto();
        } else {
          listAll();
        }
        limparFormulario();
      } else {
        showMessage(resposta.error.message, "danger");
      }
    };
    divBotoes.appendChild(btnAtualizar);

    const btnConcluir = createButton("Concluir", "btn-success");
   